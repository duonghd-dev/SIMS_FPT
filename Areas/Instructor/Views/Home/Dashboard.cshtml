@model SIMS_FPT.Models.ViewModels.InstructorDashboardViewModel

@{
    ViewData["Title"] = "Instructor Dashboard";
    Layout = "~/Areas/Instructor/Views/Shared/_InstructorLayout.cshtml";
}

<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h3 class="page-title">Welcome, @(User.Identity?.Name ?? "Instructor")!</h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item active">Dashboard</li>
            </ul>
        </div>
        <div class="col-auto text-right float-right ml-auto">
            <a asp-area="Instructor" asp-controller="Assignment" asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create Assignment
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-4 col-sm-6 col-12 d-flex">
        <div class="card bg-one w-100">
            <div class="card-body">
                <div class="db-widgets d-flex justify-content-between align-items-center">
                    <div class="db-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="db-info">
                        <h3>Assignments</h3>
                        <h6>Manage Coursework</h6>
                    </div>
                </div>
                <div class="mt-3">
                    <a asp-area="Instructor" asp-controller="Assignment" asp-action="Create"
                        class="btn btn-sm btn-white text-warning mr-2">
                        <i class="fas fa-plus"></i> New
                    </a>
                    <a asp-area="Instructor" asp-controller="Assignment" asp-action="Index"
                        class="btn btn-sm btn-white text-warning">
                        View All
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-sm-6 col-12 d-flex">
        <div class="card bg-two w-100">
            <div class="card-body">
                <div class="db-widgets d-flex justify-content-between align-items-center">
                    <div class="db-icon">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="db-info">
                        <h3>Grading</h3>
                        <h6>Review Submissions</h6>
                    </div>
                </div>
                <div class="mt-3">
                    <a asp-area="Instructor" asp-controller="Assignment" asp-action="Index"
                        class="btn btn-sm btn-white text-info">
                        <i class="fas fa-arrow-right"></i> Go to Grading
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-sm-6 col-12 d-flex">
        <div class="card bg-three w-100">
            <div class="card-body">
                <div class="db-widgets d-flex justify-content-between align-items-center">
                    <div class="db-icon">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div class="db-info">
                        <h3>Materials</h3>
                        <h6>Upload & Share</h6>
                    </div>
                </div>
                <div class="mt-3">
                    <a asp-area="Instructor" asp-controller="CourseMaterial" asp-action="Create"
                        class="btn btn-sm btn-white text-primary mr-2">
                        <i class="fas fa-upload"></i> Add
                    </a>
                    <a asp-area="Instructor" asp-controller="CourseMaterial" asp-action="Index"
                        class="btn btn-sm btn-white text-primary">
                        <i class="fas fa-folder"></i> Repository
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity-->
<div class="row">
    <div class="col-12 col-lg-8">
    </div>

    <div class="col-12 col-lg-4 d-flex">
        <div class="card flex-fill">
            <div class="card-header">
                <h5 class="card-title">Recent Activity</h5>
            </div>
            <div class="card-body">
                <ul class="activity-feed">
                    @if (Model.RecentActivities.Any())
                    {
                        foreach (var activity in Model.RecentActivities)
                        {
                            <li class="feed-item">
                                <div class="feed-date">@activity.TimeAgo</div>
                                <span class="feed-text">
                                    <a asp-area="Instructor" asp-controller="Student" asp-action="Profile"
                                        asp-route-id="@activity.StudentId">
                                        @activity.StudentName
                                    </a>
                                    submitted
                                    <strong>@activity.AssignmentTitle</strong>
                                </span>
                            </li>
                        }
                    }
                    else
                    {
                        <li class="feed-item">
                            <span class="feed-text text-muted">No recent submissions found.</span>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-12">
        <div class="card flex-fill">
            <div class="card-header">
                <h5 class="card-title">My Teaching Classes</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-center mb-0">
                        <thead>
                            <tr>
                                <th>Class Name</th>
                                <th>Subject Code</th>
                                <th>Subject Name</th>
                                <th>Semester</th>
                                <th class="text-center">Students</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.TeachingClasses != null && Model.TeachingClasses.Any())
                            {
                                foreach (var cls in Model.TeachingClasses)
                                {
                                    <tr>
                                        <td>
                                            <strong>@cls.ClassName</strong>
                                        </td>
                                        <td>@cls.SubjectCode</td>
                                        <td>@cls.SubjectName</td>
                                        <td>@cls.Semester</td>
                                        <td class="text-center">
                                            <span class="badge badge-pill bg-primary-light">@cls.StudentCount</span>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        No classes assigned for this instructor.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12 col-lg-6 d-flex">
        <div class="card card-chart flex-fill w-100">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-6">
                        <h5 class="card-title">Performance</h5>
                    </div>
                    <div class="col-6 text-right">
                        @if (Model.StudentOptions.Any())
                        {
                            <form method="get" class="d-inline-block">
                                <select name="studentId" class="form-control form-control-sm"
                                    style="width: auto; display: inline-block;" onchange="this.form.submit()">
                                    @foreach (var s in Model.StudentOptions)
                                    {
                                        if (s.StudentId == Model.SelectedStudentId)
                                        {
                                            <option value="@s.StudentId" selected>@s.StudentName</option>
                                        }
                                        else
                                        {
                                            <option value="@s.StudentId">@s.StudentName</option>
                                        }
                                    }
                                </select>
                            </form>
                        }
                        else
                        {
                            <span class="text-muted small">No students yet</span>
                        }
                    </div>
                </div>
            </div>
            <div class="card-body d-flex flex-column justify-content-between">
                <div id="performanceChart" style="flex-grow: 1;"></div>
                <div class="text-center mt-2 text-muted" style="font-size: 0.9em;">
                    Comparison: Class Average vs @Model.SelectedStudentName
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-12 col-lg-6 d-flex">
        <div class="card card-chart flex-fill w-100">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-6">
                        <h5 class="card-title">Submissions vs Graded</h5>
                    </div>
                </div>
            </div>
            <div class="card-body d-flex flex-column justify-content-between">
                <div id="submissionChart" style="flex-grow: 1;"></div>
                <div class="text-center mt-2 text-muted" style="font-size: 0.9em;">
                    Overview of Submissions vs Graded Items
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card card-table">
            <div class="card-header">
                <h5 class="card-title">
                    At-Risk Students
                    @if (Model.AtRiskStudents.Any())
                    {
                        <span class="badge badge-danger ml-2">@Model.AtRiskStudents.Count</span>
                    }
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-center mb-0">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Risk Factor</th>
                                <th>Severity</th>
                                <th class="text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.AtRiskStudents.Any())
                            {
                                foreach (var s in Model.AtRiskStudents)
                                {
                                    <tr>
                                        <td>
                                            <h2 class="table-avatar">
                                                <a asp-area="Instructor" asp-controller="Student" asp-action="Profile"
                                                    asp-route-id="@s.StudentId" class="avatar avatar-sm mr-2">
                                                    <img class="avatar-img rounded-circle"
                                                        src="~/assets/img/default-avatar-1-32.svg" alt=" User Image">
                                                </a>
                                                <a asp-area="Instructor" asp-controller="Student" asp-action="Profile"
                                                    asp-route-id="@s.StudentId">
                                                    @s.StudentName
                                                </a>
                                            </h2>
                                        </td>
                                        <td>@s.Reason</td>
                                        <td>
                                            <span
                                                class="badge badge-pill @(s.RiskLevel == "High" ? "bg-danger-light" : "bg-warning-light")">
                                                @s.RiskLevel
                                            </span>
                                        </td>
                                        <td class="text-right">
                                            <a asp-area="Instructor" asp-controller="Student" asp-action="Profile"
                                                asp-route-id="@s.StudentId" class="btn btn-sm bg-success-light">
                                                <i class="fas fa-eye"></i> View Profile
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center">Great job! No at-risk students detected.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="card-title">Sample Monthly Stats</h5>
    </div>
    <div class="card-body">
        <div id="sample-chart"></div>
    </div>
</div>

@section Scripts {
    <script src="~/assets/plugins/apexchart/apexcharts.min.js"></script>
    <script>
        $(document).ready(function () {
            // 1. DATA BINDING
            // Deserialize Razor data into JavaScript variables
            var labels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.PerformanceLabels));
            var classSeries = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.ClassAverageSeries));
            var studentSeries = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.StudentSeries));

            // 2. PERFORMANCE CHART (Area Chart)
            if (document.querySelector("#performanceChart")) {
                var performanceOptions = {
                    series: [
                        { name: 'Class Average', data: classSeries },
                        { name: '@Model.SelectedStudentName', data: studentSeries }
                    ],
                    chart: {
                        height: 350,
                        type: 'area', // Maintained as Area per file content
                        toolbar: { show: false },
                        zoom: { enabled: false }
                    },
                    dataLabels: { enabled: false },
                    stroke: {
                        curve: 'smooth',
                        width: 3
                    },
                    xaxis: {
                        categories: labels,
                        tooltip: { enabled: false }
                    },
                    // Blue for class average, Yellow for specific student
                    colors: ['#4e73df', '#fdbb38'],
                    fill: {
                        type: 'solid',
                        opacity: 0.2
                    },
                    markers: {
                        size: 5,
                        hover: { size: 7 }
                    },
                    yaxis: {
                        min: 0,
                        max: 100,
                        title: { text: 'Score' }
                    },
                    tooltip: {
                        y: { formatter: function (val) { return val + ' pts'; } }
                    },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'right'
                    }
                };
                var chartPerf = new ApexCharts(document.querySelector("#performanceChart"), performanceOptions);
                chartPerf.render();
            }

            // 3. SUBMISSIONS CHART (Changed to Circle Chart)
            if (document.querySelector("#submissionChart")) {
                var submissionOptions = {
                    series: [@Model.TotalSubmissions, @Model.TotalGraded],
                    labels: ['Total Submissions', 'Graded'],
                    chart: {
                        height: 350,
                        type: 'donut', // Changed to donut/circle chart
                        toolbar: { show: false }
                    },
                    dataLabels: { enabled: true },
                    colors: ['#19affb', '#1cc88a'],
                    fill: {
                        type: 'solid',
                        opacity: 1
                    },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'right'
                    },
                    tooltip: {
                        y: {
                            formatter: function (val) { return val + ' items'; }
                        }
                    }
                };
                var chartSub = new ApexCharts(document.querySelector("#submissionChart"), submissionOptions);
                chartSub.render();
            }

            // 4. SAMPLE MONTHLY STATS CHART (Bar Chart)
            if (document.querySelector("#sample-chart")) {
                var sampleOptions = {
                    series: [{
                        name: 'Submissions',
                        data: [@Model.TotalSubmissions, @Model.TotalGraded, @Model.TotalSubmissions - @Model.TotalGraded, @Model.TeachingClasses.Count, @Model.StudentOptions.Count]
                    }],
                    chart: {
                        height: 300,
                        type: 'bar',
                        toolbar: { show: false }
                    },
                    plotOptions: {
                        bar: {
                            horizontal: false,
                            columnWidth: '55%',
                            endingShape: 'rounded',
                            distributed: true
                        }
                    },
                    dataLabels: {
                        enabled: true
                    },
                    xaxis: {
                        categories: ['Total Submissions', 'Graded', 'Pending', 'Classes', 'Students']
                    },
                    colors: ['#4e73df', '#1cc88a', '#f6c23e', '#858796', '#e74a3b'],
                    legend: {
                        show: false
                    },
                    yaxis: {
                        title: {
                            text: 'Count'
                        }
                    }
                };
                var chartSample = new ApexCharts(document.querySelector("#sample-chart"), sampleOptions);
                chartSample.render();
            }
        });
    </script>
}