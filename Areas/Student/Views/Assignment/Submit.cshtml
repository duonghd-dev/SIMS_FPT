@model SIMS_FPT.Models.ViewModels.StudentAssignmentViewModel

@{
    ViewData["Title"] = "Submit Assignment";
    Layout = "~/Areas/Student/Views/Shared/_StudentLayout.cshtml";

    // Logic kiểm tra quá hạn ngay tại View
    bool isOverdue = DateTime.Now > Model.Assignment.DueDate;
}

<div class="page-wrapper">
    <div class="content container-fluid">

        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title">Submit Assignment</h3>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Dashboard">Dashboard</a></li>
                        <li class="breadcrumb-item"><a asp-action="Index">Assignments</a></li>
                        <li class="breadcrumb-item active">Submit</li>
                    </ul>
                </div>
            </div>
        </div>
       <div class="row">
            <div class="col-md-12">
                @if (TempData["Error"] != null)
                {
                    <div class="alert alert-danger">@TempData["Error"]</div>
                }
                @if (TempData["Success"] != null)
                {
                    <div class="alert alert-success">@TempData["Success"]</div>
                }

                <div class="card">
                    <div class="card-body">
                        <form asp-action="Submit" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="id" value="@Model.Assignment.AssignmentId" />
                            @if (!isOverdue && (!Model.HasSubmission || !Model.HasGrade))
                            {
                                <div class="form-group row">
                                    <label class="col-form-label col-md-2">Upload file</label>
                                    <div class="col-md-10">
                                        <input type="file" name="uploadFile" class="form-control" />
                                        <small class="form-text text-muted">Uploading again will replace your previous submission.</small>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Submission
                                    </button>
                                </div>
                            }
                        </form>

                        @if (Model.HasSubmission)
                        {
                            <div class="alert alert-info mt-4">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h5 class="alert-heading mb-1">Submission Received</h5>
                                        <p class="mb-0">
                                            <strong>File:</strong> 
                                            <a asp-action="Download" asp-route-id="@Model.Assignment.AssignmentId" class="alert-link text-decoration-underline">
                                                <i class="fas fa-download"></i> Download Submission
                                            </a> 
                                            <br />
                                            <strong>Submitted at:</strong> @Model.SubmittedAt?.ToString("dd/MM/yyyy HH:mm")
                                        </p>
                                    </div>
                                    @if (!Model.HasGrade && !isOverdue)
                                    {
                                        <div class="col-auto">
                                            <form asp-action="DeleteSubmission" method="post" onsubmit="return confirm('Are you sure you want to delete this submission? This cannot be undone.');">
                                                <input type="hidden" name="id" value="@Model.Assignment.AssignmentId" />
                                                <button type="submit" class="btn btn-danger btn-sm">
                                                    <i class="fas fa-trash-alt"></i> Remove Submission
                                                </button>
                                            </form>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (Model.Assignment.AreGradesPublished && Model.HasGrade)
                        {
                            <div class="alert alert-success mt-3">
                                <h5 class="alert-heading"><i class="fas fa-check-circle"></i> Graded</h5>
                                <hr>
                                <p class="mb-1"><strong>Score:</strong> <span class="badge badge-pill badge-success" style="font-size: 1em;">@Model.Grade / @Model.Assignment.MaxPoints</span></p>
                                @if (!string.IsNullOrWhiteSpace(Model.TeacherComments))
                                {
                                    <p class="mb-0"><strong>Teacher Comments:</strong> @Model.TeacherComments</p>
                                }
                                <div class="text-muted small mt-2">
                                    <em>* You cannot delete or edit this submission because it has been graded.</em>
                                </div>
                            </div>
                        }

                        <div class="mt-4">
                            <a asp-action="Index" class="btn btn-secondary">Back to List</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>